# CI/CD 工作流程说明

## 工作流程概述

### 1. 构建工作流 (build.yml)
主要负责HAOS Rock5B镜像的自动构建。

触发条件：
- 手动触发（workflow_dispatch）
- 定时构建（每周日晚上18:00）
- 版本标签推送

主要功能：
- 自动获取最新HAOS版本
- 优化构建环境
- 使用中国镜像源加速
- 自动发布到GitHub Releases

### 2. 检查工作流 (check.yml)
负责代码质量和构建依赖检查。

触发条件：
- Pull Request
- 推送到main分支

检查项目：
- 配置文件格式
- 设备树文件
- Shell脚本语法
- 构建依赖完整性

### 3. 发布工作流 (release.yml)
管理版本发布流程。

触发条件：
- 手动触发（需指定版本号）

功能：
- 自动生成更新日志
- 创建GitHub Release
- 更新版本文件
- 触发构建流程
- 发送发布通知

## 使用说明

### 手动触发构建
1. 进入Actions页面
2. 选择"HAOS-Rock5B"工作流
3. 点击"Run workflow"
4. 等待构建完成

### 创建新版本发布
1. 进入Actions页面
2. 选择"Release Management"工作流
3. 点击"Run workflow"
4. 输入版本号
5. 选择是否为预发布版本
6. 确认执行

### 查看构建检查结果
1. 在Pull Request中自动运行
2. 检查结果会在PR中显示
3. 详细日志可在Actions页面查看

## 环境变量和密钥

需要配置的密钥：
- GITHUB_TOKEN（自动提供）
- DOCKER_USERNAME（可选，用于Docker Hub登录）
- DOCKER_PASSWORD（可选，用于Docker Hub登录）
- RAUC_CERTIFICATE（可选，用于签名）
- RAUC_PRIVATE_KEY（可选，用于签名）

## 注意事项

1. 构建优化
   - 自动清理磁盘空间
   - 使用缓存加速构建
   - 失败自动重试3次

2. 网络优化
   - 使用中国区镜像源
   - 配置国内NTP服务器
   - 优化下载速度

3. 发布管理
   - 自动生成更新日志
   - 版本号管理
   - 发布通知

4. 代码质量
   - 自动检查代码格式
   - 验证配置文件
   - 检查构建依赖

## 常见问题

1. 构建失败排查
   - 检查构建日志
   - 验证依赖完整性
   - 确认磁盘空间充足

2. 发布流程问题
   - 确保版本号格式正确
   - 检查权限设置
   - 验证密钥配置

3. 网络问题
   - 确认镜像源可用性
   - 检查网络连接
   - 验证代理设置

## 贡献指南

1. 提交PR前：
   - 运行本地检查
   - 更新文档
   - 添加测试用例

2. 代码审查：
   - 等待CI检查完成
   - 解决反馈问题
   - 确保所有检查通过