# HAOS Rock5B å‘å¸ƒç®¡ç†å·¥ä½œæµ
name: Release Management

# æ‰‹åŠ¨è§¦å‘å‚æ•°
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å·'
        required: true
        default: ''
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        type: boolean
        required: false
        default: false

jobs:
  prepare-release:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°Ubuntuè¿è¡Œå™¨
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: è®¾ç½®ç¯å¢ƒ
        run: |
          # è®¾ç½®ä¸­å›½æ—¶åŒº
          sudo timedatectl set-timezone "Asia/Shanghai"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "RELEASE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          if [ -z "$PREV_TAG" ]; then
            # é¦–æ¬¡å‘å¸ƒï¼Œè·å–æ‰€æœ‰æäº¤
            CHANGES=$(git log --pretty=format:"* %s (%h)" --no-merges)
          else
            # è·å–ä»ä¸Šä¸ªæ ‡ç­¾åˆ°ç°åœ¨çš„æäº¤
            CHANGES=$(git log ${PREV_TAG}..HEAD --pretty=format:"* %s (%h)" --no-merges)
          fi
          
          # ç”Ÿæˆæ›´æ–°æ—¥å¿—æ–‡ä»¶
          echo "# æ›´æ–°æ—¥å¿— (${{ env.RELEASE_DATE }})" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ç‰ˆæœ¬ ${{ env.VERSION }}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "$CHANGES" >> CHANGELOG.md
          
          # ä¸ºGitHub Actionsè®¾ç½®è¾“å‡º
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "changelog<<$EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        run: |
          # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
          echo "${{ env.VERSION }}" > VERSION
          
          # æäº¤ç‰ˆæœ¬æ›´æ–°
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add VERSION
          git commit -m "chore: bump version to ${{ env.VERSION }}"
          git push

      - name: è§¦å‘æ„å»º
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: trigger-build
          client-payload: '{"version": "${{ env.VERSION }}"}'

  notify:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: å‘é€é€šçŸ¥
        uses: actions/github-script@v6
        with:
          script: |
            const { repo, owner } = context.repo;
            const release_url = `https://github.com/${owner}/${repo}/releases/tag/v${{ env.VERSION }}`;
            
            // å‘å¸ƒé€šçŸ¥æ¶ˆæ¯
            const message = `
            ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒé€šçŸ¥
            
            ç‰ˆæœ¬: v${{ env.VERSION }}
            å‘å¸ƒæ—¥æœŸ: ${{ env.RELEASE_DATE }}
            
            æŸ¥çœ‹å‘å¸ƒè¯¦æƒ…: ${release_url}
            `;
            
            // åˆ›å»ºIssueé€šçŸ¥
            await github.rest.issues.create({
              owner,
              repo,
              title: `Release v${{ env.VERSION }} å·²å‘å¸ƒ`,
              body: message,
              labels: ['release']
            });